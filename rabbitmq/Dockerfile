FROM debian:bookworm

RUN apt update && apt upgrade -y

COPY ./tools/install.sh .

RUN chmod u+x install.sh && ./install.sh

ARG RABBITMQ_HOST
ENV RABBITMQ_HOST=${RABBITMQ_HOST}
ARG RABBITMQ_PORT
ENV RABBITMQ_PORT=${RABBITMQ_PORT}
ARG RABBITMQ_NODENAME
ENV RABBITMQ_NODENAME=${RABBITMQ_NODENAME}
ARG RABBITMQ_API_GATEWAY_USER
ENV RABBITMQ_API_GATEWAY_USER=${RABBITMQ_API_GATEWAY_USER}
ARG RABBITMQ_API_GATEWAY_PASSWORD
ENV RABBITMQ_API_GATEWAY_PASSWORD=${RABBITMQ_API_GATEWAY_PASSWORD}
ARG RABBITMQ_USER_MANAGER_USER
ENV RABBITMQ_USER_MANAGER_USER=${RABBITMQ_USER_MANAGER_USER}
ARG RABBITMQ_USER_MANAGER_PASSWORD
ENV RABBITMQ_USER_MANAGER_PASSWORD=${RABBITMQ_USER_MANAGER_PASSWORD}
ARG RABBITMQ_FRIENDS_MANAGER_USER
ENV RABBITMQ_FRIENDS_MANAGER_USER=${RABBITMQ_FRIENDS_MANAGER_USER}
ARG RABBITMQ_FRIENDS_MANAGER_PASSWORD
ENV RABBITMQ_FRIENDS_MANAGER_PASSWORD=${RABBITMQ_FRIENDS_MANAGER_PASSWORD}
ARG RABBITMQ_NOTIFICATIONS_USER
ENV RABBITMQ_NOTIFICATIONS_USER=${RABBITMQ_NOTIFICATIONS_USER}
ARG RABBITMQ_NOTIFICATIONS_PASSWORD
ENV RABBITMQ_NOTIFICATIONS_PASSWORD=${RABBITMQ_NOTIFICATIONS_PASSWORD}
ARG RABBITMQ_LEADERBOARD_USER
ENV RABBITMQ_LEADERBOARD_USER=${RABBITMQ_LEADERBOARD_USER}
ARG RABBITMQ_LEADERBOARD_PASSWORD
ENV RABBITMQ_LEADERBOARD_PASSWORD=${RABBITMQ_LEADERBOARD_PASSWORD}
ARG RABBITMQ_MATCH_MANAGER_USER
ENV RABBITMQ_MATCH_MANAGER_USER=${RABBITMQ_MATCH_MANAGER_USER}
ARG RABBITMQ_MATCH_MANAGER_PASSWORD
ENV RABBITMQ_MATCH_MANAGER_PASSWORD=${RABBITMQ_MATCH_MANAGER_PASSWORD}

COPY ./conf/rabbitmq.conf /etc/rabbitmq/rabbitmq.conf

COPY ./tools/users.sh .

RUN chmod u+x users.sh && ./users.sh

EXPOSE 5577

ENTRYPOINT [ "rabbitmq-server" ]
